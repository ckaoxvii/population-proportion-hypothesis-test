[{"name":"app.R","content":"library(shiny)\n\nlibrary(bslib)\n\nlibrary(ggplot2)\n\nui <- page_fillable(\n  title = \"Hypothesis Test for Population Proportions\",\n  theme = bs_theme(primary = \"#A90533\"),\n  withMathJax(),\n  div(\n    style = \"text-align: left; margin-bottom: 20px; background-color: #A90533; padding: 20px; border-radius: 5px;\",\n    h1(\"Hypothesis Test for Population Proportions\",\n       style = \"color: white; font-weight: bold; margin: 0;\")\n  ),\n  layout_sidebar(\n    sidebar = sidebar(\n      selectInput(\n        \"test_type\", \"Test Type:\",\n        list(\"One-Sample Prop\" = \"one\", \"Two-Sample Prop\" = \"two\")\n      ),\n\n      # One-sample inputs\n      conditionalPanel(\n        condition = \"input.test_type == 'one'\",\n        numericInput(\"p0\",    \"Null Proportion: p\\u2080\", value = 0.5, min = 0, max = 1, step = 0.01),\n        numericInput(\"p_hat\", \"Sample Proportion: p\\u0302\", value = 0.55, min = 0, max = 1, step = 0.001),\n        numericInput(\"n\",     \"Sample Size: n\", value = 100, min = 1, step = 1)\n      ),\n\n      # Two-sample inputs\n      conditionalPanel(\n        condition = \"input.test_type == 'two'\",\n        numericInput(\"p1hat\", \"Group 1 Proportion: p\\u0302\\u2081\", value = 0.60, min = 0, max = 1, step = 0.001),\n        numericInput(\"n1\",    \"Group 1 Size: n\\u2081\", value = 120, min = 1, step = 1),\n        numericInput(\"p2hat\", \"Group 2 Proportion: p\\u0302\\u2082\", value = 0.50, min = 0, max = 1, step = 0.001),\n        numericInput(\"n2\",    \"Group 2 Size: n\\u2082\", value = 100, min = 1, step = 1)\n      ),\n\n      # Shared controls\n      numericInput(\"alpha\", \"Significance Level: \\u03B1\", value = 0.05, min = 0.0001, max = 0.5, step = 0.001),\n      selectInput(\n        \"alt\", \"Alternative Hypothesis\",\n        choices = c(\"Two-Sided: ≠\" = \"two.sided\", \"Right-Sided: >\" = \"greater\", \"Left-Sided: <\" = \"less\"),\n        selected = \"two.sided\"\n      )\n    ),\n\n    # Main content\n    div(class = \"app-fill main-fill\",\n      navset_card_pill(\n        nav_panel(\n          \"Test Summary\",\n          card_body(tableOutput(\"summary\"))\n        ),\n        nav_panel(\n          \"Visualize p-Value\",\n          card_body(\n            # container for overlay\n            div(\n              style = \"position: relative;\",\n              plotOutput(\"pplot\", height = \"420px\"),\n              # overlay card\n              div(\n                class = \"card shadow-sm\",\n                style = paste(\n                  \"position: absolute; top: 16px; left: 100px;\",\n                  \"background-color: white; opacity: 0.94;\",\n                  \"border-radius: 12px; padding: 10px 14px;\",\n                  \"border: 1px solid #e5e7eb; font-size: 0.95rem; color: #333;\"\n                ),\n                htmlOutput(\"zpvals\")\n              )\n            )\n          )\n        ),\n        nav_panel(\n          \"Conclusion\",\n          card_body(\n            h5(textOutput(\"hypotheses\")),\n            h5(textOutput(\"decision\")),\n            p(textOutput(\"conclusion\"))\n          )\n        )\n      )\n    )\n  )\n)\n\nserver <- function(input, output, session) {\n\n  fmt  <- function(x, d = 4) formatC(x, format = \"f\", digits = d)\n  fmtp <- function(p) ifelse(p < 1e-4, formatC(p, format = \"e\", digits = 2),\n                             formatC(p, format = \"f\", digits = 6))\n\n  # Core reactive calculations (branches by test type)\n  calc <- reactive({\n    alpha <- input$alpha\n    alt   <- input$alt\n    ttype <- input$test_type\n\n    if (ttype == \"one\") {\n      p0 <- input$p0; ph <- input$p_hat; n <- input$n\n      se <- sqrt(p0 * (1 - p0) / n)\n      z  <- (ph - p0) / se\n\n      if (alt == \"two.sided\") {\n        pval <- 2 * pnorm(-abs(z)); zcrit <- qnorm(1 - alpha/2); reject <- abs(z) > zcrit; crit_desc <- paste0(\"±\", round(zcrit, 3))\n      } else if (alt == \"greater\") {\n        pval <- 1 - pnorm(z);       zcrit <- qnorm(1 - alpha);    reject <- z > zcrit;       crit_desc <- paste0(round(zcrit, 3))\n      } else {\n        pval <- pnorm(z);           zcrit <- qnorm(alpha);        reject <- z < zcrit;       crit_desc <- paste0(round(zcrit, 3))\n      }\n\n      list(type=\"one\", alpha=alpha, alt=alt, p0=p0, ph=ph, n=n, se=se, z=z, pval=pval, zcrit=zcrit, reject=reject, crit_desc=crit_desc)\n\n    } else {\n      p1 <- input$p1hat; n1 <- input$n1; p2 <- input$p2hat; n2 <- input$n2\n      p_pool <- (p1*n1 + p2*n2) / (n1 + n2)\n      se <- sqrt(p_pool * (1 - p_pool) * (1/n1 + 1/n2))\n      z  <- (p1 - p2) / se\n\n      if (alt == \"two.sided\") {\n        pval <- 2 * pnorm(-abs(z)); zcrit <- qnorm(1 - alpha/2); reject <- abs(z) > zcrit; crit_desc <- paste0(\"±\", round(zcrit, 3))\n      } else if (alt == \"greater\") {\n        pval <- 1 - pnorm(z);       zcrit <- qnorm(1 - alpha);    reject <- z > zcrit;       crit_desc <- paste0(round(zcrit, 3))\n      } else {\n        pval <- pnorm(z);           zcrit <- qnorm(alpha);        reject <- z < zcrit;       crit_desc <- paste0(round(zcrit, 3))\n      }\n\n      list(type=\"two\", alpha=alpha, alt=alt, p1=p1, n1=n1, p2=p2, n2=n2, p_pool=p_pool, se=se, z=z, pval=pval, zcrit=zcrit, reject=reject, crit_desc=crit_desc)\n    }\n  })\n\n  # Hypotheses text\n  output$hypotheses <- renderText({\n    cdat <- calc()\n    if (cdat$type == \"one\") {\n      h1 <- paste0(\"H0: p = \", fmt(cdat$p0, 3))\n      h2 <- switch(cdat$alt,\n        two.sided = paste0(\"H1: p ≠ \", fmt(cdat$p0, 3)),\n        greater   = paste0(\"H1: p > \", fmt(cdat$p0, 3)),\n        less      = paste0(\"H1: p < \", fmt(cdat$p0, 3))\n      )\n    } else {\n      h1 <- \"H0: p1 = p2\"\n      h2 <- switch(cdat$alt,\n        two.sided = \"H1: p1 ≠ p2\",\n        greater   = \"H1: p1 > p2\",\n        less      = \"H1: p1 < p2\"\n      )\n    }\n    paste(h1, \" | \", h2)\n  })\n\n  # Summary table\n  output$summary <- renderTable({\n    cdat <- calc()\n    if (cdat$type == \"one\") {\n      data.frame(\n        Quantity = c(\"Null proportion (p0)\", \"Sample proportion (p̂)\", \"n\",\n                     \"Standard error (SE)\", \"Test statistic (z)\", \"p-value\",\n                     \"Significance (α)\", \"Critical value(s)\"),\n        Value = c(fmt(cdat$p0, 4), fmt(cdat$ph, 4), cdat$n,\n                  fmt(cdat$se, 6), fmt(cdat$z, 4), fmt(cdat$pval, 6),\n                  fmt(cdat$alpha, 4), cdat$crit_desc),\n        check.names = FALSE\n      )\n    } else {\n      data.frame(\n        Quantity = c(\"p̂1\", \"n1\", \"p̂2\", \"n2\",\n                     \"Pooled proportion (p̂_pool)\", \"Standard error (SE)\",\n                     \"Test statistic (z)\", \"p-value\",\n                     \"Significance (α)\", \"Critical value(s)\"),\n        Value = c(fmt(cdat$p1, 4), cdat$n1, fmt(cdat$p2, 4), cdat$n2,\n                  fmt(cdat$p_pool, 6), fmt(cdat$se, 6),\n                  fmt(cdat$z, 4), fmt(cdat$pval, 6),\n                  fmt(cdat$alpha, 4), cdat$crit_desc),\n        check.names = FALSE\n      )\n    }\n  }, striped = TRUE, bordered = TRUE, digits = 4)\n\n  # Decision & conclusion\n  output$decision <- renderText({\n    if (calc()$reject) paste0(\"Decision: Reject H0 at α = \", fmt(calc()$alpha, 4))\n    else               paste0(\"Decision: Fail to reject H0 at α = \", fmt(calc()$alpha, 4))\n  })\n\n  output$conclusion <- renderText({\n    cdat <- calc()\n    dir_text <- if (cdat$type == \"one\") {\n      switch(cdat$alt,\n             two.sided = \"that p ≠ p0\",\n             greater   = \"that p > p0\",\n             less      = \"that p < p0\")\n    } else {\n      switch(cdat$alt,\n             two.sided = \"that p1 ≠ p2\",\n             greater   = \"that p1 > p2\",\n             less      = \"that p1 < p2\")\n    }\n\n    paste0(\n      if (cdat$reject) \"There is sufficient evidence to conclude \" else\n        \"There is not sufficient evidence to conclude \",\n      dir_text,\n      \" (z = \", fmt(cdat$z, 4), \", p = \", fmtp(cdat$pval), \").\"\n    )\n  })\n\n  # Overlay content (z & p) for the plot tab\n  output$zpvals <- renderUI({\n    cdat <- calc()\n    tags$div(\n      style = \"line-height: 1.25;\",\n      tags$div(tags$b(\"z-statistic: \"), sprintf(\"%.4f\", cdat$z)),\n      tags$div(tags$b(\"p-value: \"),     fmtp(cdat$pval))\n    )\n  })\n\n  # P-value plot\n  output$pplot <- renderPlot({\n  cdat <- calc()\n  z   <- cdat$z\n  alt <- cdat$alt\n\n  x <- seq(-4, 4, length.out = 4000)\n  df <- data.frame(x = x, y = dnorm(x))\n\n  # Prepare tail data explicitly\n  z_abs <- abs(z)\n  left_tail  <- NULL\n  right_tail <- NULL\n  one_tail   <- NULL\n\n  if (alt == \"two.sided\") {\n    left_tail  <- subset(df, x <= -z_abs)\n    right_tail <- subset(df, x >=  z_abs)\n  } else if (alt == \"greater\") {\n    one_tail <- subset(df, x >= z)\n  } else { # alt == \"less\"\n    one_tail <- subset(df, x <= z)\n  }\n\n  g <- ggplot(df, aes(x, y)) +\n    geom_line(linewidth = 0.9) +\n    # --- fill tails only ---\n    {\n      if (alt == \"two.sided\") {\n        list(\n          geom_area(data = left_tail,  aes(x = x, y = y), fill = \"#A90533\", alpha = 0.30, inherit.aes = FALSE),\n          geom_area(data = right_tail, aes(x = x, y = y), fill = \"#A90533\", alpha = 0.30, inherit.aes = FALSE)\n        )\n      } else {\n        geom_area(data = one_tail, aes(x = x, y = y), fill = \"#A90533\", alpha = 0.30, inherit.aes = FALSE)\n      }\n    } +\n    # --- vertical line(s) ---\n    {\n      if (alt == \"two.sided\") {\n        list(\n          geom_vline(xintercept = -z_abs, linetype = \"dashed\", linewidth = 0.9, color = \"#A90533\"),\n          geom_vline(xintercept =  z_abs, linetype = \"dashed\", linewidth = 0.9, color = \"#A90533\")\n        )\n      } else {\n        geom_vline(xintercept = z, linetype = \"dashed\", linewidth = 0.9, color = \"#A90533\")\n      }\n    } +\n    annotate(\"text\", x = z, y = 0, label = paste0(\"z = \", round(z, 3)),\n             vjust = 3, color = \"#A90533\") +\n    labs(y = \"Density\") +\n    coord_cartesian(clip = \"off\") +\n    theme_minimal(base_size = 13)\n\n    g\n  })\n}\n\nshinyApp(ui, server)","type":"text"}]
