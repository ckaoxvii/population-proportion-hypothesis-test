[{"name":"app.R","content":"# app.R\nlibrary(shiny)\nlibrary(bslib)\nlibrary(ggplot2)\n\nui <- page_fillable(\n  title = \"Hypothesis Test for Population Proportions\",\n  theme = bs_theme(primary = \"#A90533\"),\n  withMathJax(),\n  div(\n    style = \"text-align: left; margin-bottom: 20px; background-color: #A90533; padding: 20px; border-radius: 5px;\",\n    h1(\"Hypothesis Test for Population Proportions\",\n       style = \"color: white; font-weight: bold; margin: 0;\")\n  ),\n  layout_sidebar(\n    sidebar = sidebar(\n      selectInput(\n        \"test_type\", \"Test Type:\",\n        list(\"One-Sample Prop\" = \"one\", \"Two-Sample Prop\" = \"two\")\n      ),\n\n      # One-sample inputs\n      conditionalPanel(\n        condition = \"input.test_type == 'one'\",\n        numericInput(\"p0\",    \"Null Proportion: p\\u2080\", value = 0.5, min = 0, max = 1, step = 0.01),\n        numericInput(\"p_hat\", \"Sample Proportion: p\\u0302\", value = 0.55, min = 0, max = 1, step = 0.001),\n        numericInput(\"n\",     \"Sample Size: n\", value = 100, min = 1, step = 1)\n      ),\n\n      # Two-sample inputs\n      conditionalPanel(\n        condition = \"input.test_type == 'two'\",\n        numericInput(\"p1hat\", \"Group 1 Proportion: p\\u0302\\u2081\", value = 0.60, min = 0, max = 1, step = 0.001),\n        numericInput(\"n1\",    \"Group 1 Size: n\\u2081\", value = 120, min = 1, step = 1),\n        numericInput(\"p2hat\", \"Group 2 Proportion: p\\u0302\\u2082\", value = 0.50, min = 0, max = 1, step = 0.001),\n        numericInput(\"n2\",    \"Group 2 Size: n\\u2082\", value = 100, min = 1, step = 1)\n      ),\n\n      # Shared controls\n      numericInput(\"alpha\", \"Significance Level: \\u03B1\", value = 0.05, min = 0.0001, max = 0.5, step = 0.001),\n      selectInput(\n        \"alt\", \"Alternative Hypothesis\",\n        choices = c(\"Two-Sided: â‰ \" = \"two.sided\", \"Right-Sided: >\" = \"greater\", \"Left-Sided: <\" = \"less\"),\n        selected = \"two.sided\"\n      )\n    ),\n\n    # Main content\n    div(class = \"app-fill main-fill\",\n      navset_card_pill(\n        nav_panel(\n          \"Test Summary\",\n          card_body(tableOutput(\"summary\"))\n        ),\n        nav_panel(\n          \"Visualize p-Value\",\n          card_body(\n            div(\n              style = \"position: relative;\",\n              plotOutput(\"pplot\", height = \"420px\"),\n              # overlay card (left side of the plot)\n              div(\n                class = \"card shadow-sm\",\n                style = paste(\n                  \"position: absolute; top: 16px; left: 100px;\",\n                  \"background-color: white; opacity: 0.94;\",\n                  \"border-radius: 12px; padding: 10px 14px;\",\n                  \"border: 1px solid #e5e7eb; font-size: 0.95rem; color: #333;\"\n                ),\n                htmlOutput(\"zpvals\")\n              )\n            )\n          )\n        )\n      )\n    )\n  )\n)\n\nserver <- function(input, output, session) {\n\n  fmt  <- function(x, d = 4) formatC(x, format = \"f\", digits = d)\n  fmtp <- function(p) ifelse(p < 1e-4, formatC(p, format = \"e\", digits = 2),\n                             formatC(p, format = \"f\", digits = 6))\n\n  # Core reactive calculations (branches by test type)\n  calc <- reactive({\n    alpha <- input$alpha\n    alt   <- input$alt\n    ttype <- input$test_type\n\n    if (ttype == \"one\") {\n      p0 <- input$p0; ph <- input$p_hat; n <- input$n\n\n      # Test SE uses p0; CI SE uses p-hat\n      se_test <- sqrt(p0 * (1 - p0) / n)\n      se_ci   <- sqrt(ph * (1 - ph) / n)\n      z  <- (ph - p0) / se_test\n\n      # p-value\n      if (alt == \"two.sided\") {\n        pval <- 2 * pnorm(-abs(z)); zstar <- qnorm(1 - alpha/2)\n        lo <- ph - zstar * se_ci; hi <- ph + zstar * se_ci\n      } else if (alt == \"greater\") {\n        pval <- 1 - pnorm(z);       zstar <- qnorm(1 - alpha)\n        lo <- ph - zstar * se_ci;   hi <- NA\n      } else {\n        pval <- pnorm(z);           zstar <- qnorm(1 - alpha)\n        lo <- NA;                   hi <- ph + zstar * se_ci\n      }\n\n      # clamp CI into [0,1]\n      lo <- if (!is.na(lo)) pmax(0, lo) else NA\n      hi <- if (!is.na(hi)) pmin(1, hi) else NA\n\n      list(\n        type=\"one\", alpha=alpha, alt=alt,\n        p0=p0, ph=ph, n=n, x=round(ph*n),\n        se_test=se_test, se_ci=se_ci, z=z, pval=pval,\n        ci_lo=lo, ci_hi=hi\n      )\n\n    } else {\n      p1 <- input$p1hat; n1 <- input$n1; p2 <- input$p2hat; n2 <- input$n2\n\n      # Test SE uses pooled; CI SE uses unpooled\n      p_pool <- (p1*n1 + p2*n2) / (n1 + n2)\n      se_test <- sqrt(p_pool * (1 - p_pool) * (1/n1 + 1/n2))     # pooled (for z-test)\n      se_ci   <- sqrt(p1 * (1 - p1) / n1 + p2 * (1 - p2) / n2)   # unpooled (for CI)\n\n      diff_hat <- p1 - p2\n      z  <- diff_hat / se_test\n\n      if (alt == \"two.sided\") {\n        pval <- 2 * pnorm(-abs(z)); zstar <- qnorm(1 - alpha/2)\n        lo <- diff_hat - zstar * se_ci; hi <- diff_hat + zstar * se_ci\n      } else if (alt == \"greater\") {\n        pval <- 1 - pnorm(z);       zstar <- qnorm(1 - alpha)\n        lo <- diff_hat - zstar * se_ci; hi <- NA\n      } else {\n        pval <- pnorm(z);           zstar <- qnorm(1 - alpha)\n        lo <- NA;                   hi <- diff_hat + zstar * se_ci\n      }\n\n      list(\n        type=\"two\", alpha=alpha, alt=alt,\n        p1=p1, n1=n1, x1=round(p1*n1),\n        p2=p2, n2=n2, x2=round(p2*n2),\n        diff_hat=diff_hat,\n        se=se_test, se_ci=se_ci, z=z, pval=pval,\n        ci_lo=lo, ci_hi=hi\n      )\n    }\n  })\n\n  # ---- Results table in requested format ----\n  output$summary <- renderTable({\n    cdat <- calc()\n    if (cdat$type == \"one\") {\n      data.frame(\n        `Proportion`   = \"p\",\n        `Count`        = cdat$x,\n        `Total`        = cdat$n,\n        `Sample Prop.` = fmt(cdat$ph, 4),\n        `Std. Err.`    = fmt(cdat$se_ci, 6),   # SE for CI\n        `Z-Stat`       = fmt(cdat$z, 4),\n        `P-value`      = fmtp(cdat$pval),\n        `Lower`        = if (is.na(cdat$ci_lo)) \"\" else fmt(cdat$ci_lo, 4),\n        `Upper`        = if (is.na(cdat$ci_hi)) \"\" else fmt(cdat$ci_hi, 4),\n        check.names = FALSE\n      )\n    } else {\n      # Single row with the difference and both groups' counts/totals\n      data.frame(\n        `Difference`   = \"p1 - p2\",\n        `Count1`       = cdat$x1,\n        `Total1`       = cdat$n1,\n        `Count2`       = cdat$x2,\n        `Total2`       = cdat$n2,\n        `Sample Diff.` = fmt(cdat$diff_hat, 7),\n        `Std. Err.`    = fmt(cdat$se, 8),      # pooled SE for the hypothesis test\n        `Z-Stat`       = fmt(cdat$z, 6),\n        `P-value`      = fmtp(cdat$pval),\n        `Lower`        = if (is.na(cdat$ci_lo)) \"\" else fmt(cdat$ci_lo, 6),\n        `Upper`        = if (is.na(cdat$ci_hi)) \"\" else fmt(cdat$ci_hi, 6),\n        check.names = FALSE\n      )\n    }\n  }, striped = TRUE, bordered = TRUE, digits = 4)\n\n  # Overlay content (z & p) for the plot tab\n  output$zpvals <- renderUI({\n    cdat <- calc()\n    tags$div(\n      style = \"line-height: 1.25;\",\n      tags$div(tags$b(\"z-statistic: \"), sprintf(\"%.4f\", cdat$z)),\n      tags$div(tags$b(\"p-value: \"),     fmtp(cdat$pval))\n    )\n  })\n\n  # P-value plot with correct tail shading\n  output$pplot <- renderPlot({\n    cdat <- calc()\n    z   <- cdat$z\n    alt <- cdat$alt\n\n    x  <- seq(-4, 4, length.out = 4000)\n    df <- data.frame(x = x, y = dnorm(x))\n\n    z_abs <- abs(z)\n\n    if (alt == \"two.sided\") {\n      left_tail  <- subset(df, x <= -z_abs)\n      right_tail <- subset(df, x >=  z_abs)\n    } else if (alt == \"greater\") {\n      one_tail <- subset(df, x >= z)\n    } else {\n      one_tail <- subset(df, x <= z)\n    }\n\n    ggplot(df, aes(x, y)) +\n      geom_line(linewidth = 0.9) +\n      {\n        if (alt == \"two.sided\") {\n          list(\n            geom_area(data = left_tail,  aes(x = x, y = y), fill = \"#A90533\", alpha = 0.30, inherit.aes = FALSE),\n            geom_area(data = right_tail, aes(x = x, y = y), fill = \"#A90533\", alpha = 0.30, inherit.aes = FALSE)\n          )\n        } else {\n          geom_area(data = one_tail, aes(x = x, y = y), fill = \"#A90533\", alpha = 0.30, inherit.aes = FALSE)\n        }\n      } +\n      {\n        if (alt == \"two.sided\") {\n          list(\n            geom_vline(xintercept = -z_abs, linetype = \"dashed\", linewidth = 0.9, color = \"#A90533\"),\n            geom_vline(xintercept =  z_abs, linetype = \"dashed\", linewidth = 0.9, color = \"#A90533\"),\n            annotate(\"text\", x = -z_abs, y = 0, label = paste0(\"z = -\", round(z_abs, 3)),\n                     vjust = 3, color = \"#A90533\"),\n            annotate(\"text\", x =  z_abs, y = 0, label = paste0(\"z = \",  round(z_abs, 3)),\n                     vjust = 3, color = \"#A90533\")\n          )\n        } else {\n          list(\n            geom_vline(xintercept = z, linetype = \"dashed\", linewidth = 0.9, color = \"#A90533\"),\n            annotate(\"text\", x = z, y = 0, label = paste0(\"z = \", round(z, 3)),\n                     vjust = 3, color = \"#A90533\")\n          )\n        }\n      } +\n      labs(y = \"Density\") +\n      coord_cartesian(clip = \"off\") +\n      theme_minimal(base_size = 13)\n  })\n}\n\nshinyApp(ui, server)","type":"text"}]
